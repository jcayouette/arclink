---
# K3s agent installation

- name: Create K3s config directory
  file:
    path: "{{ k3s_config_dir }}"
    state: directory
    mode: '0755'
  become: yes

- name: Deploy registries.yaml to agent
  template:
    src: "{{ playbook_dir }}/../roles/docker-registry/templates/registries.yaml.j2"
    dest: "{{ k3s_config_dir }}/registries.yaml"
    mode: '0644'
  become: yes

- name: Check if K3s is already installed
  stat:
    path: "{{ k3s_install_check }}"
  register: k3s_installed

- name: Get K3s token from primary master
  set_fact:
    k3s_cluster_token: "{{ hostvars[groups['k3s_master'][0]]['k3s_cluster_token'] }}"

- name: Install K3s agent
  shell: |
    curl -sfL {{ k3s_install_script }} | K3S_URL=https://{{ hostvars[groups['k3s_master'][0]]['ansible_host'] }}:6443 \
      K3S_TOKEN={{ k3s_cluster_token }} sh -
  when: not k3s_installed.stat.exists
  become: yes

- name: Ensure K3s-agent service is running
  systemd:
    name: k3s-agent
    state: started
    enabled: yes
  become: yes

- name: Display agent node status
  debug:
    msg: "K3s agent installed on {{ inventory_hostname }}"
