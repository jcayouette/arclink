---
# Font installation and configuration tasks
# Installs NerdFonts for SSH sessions and configures console fonts

- name: Install font dependencies
  apt:
    name:
      - unzip
      - fontconfig
      - console-setup
      - kbd
    state: present
    update_cache: yes
  become: yes

- name: Create fonts directory
  file:
    path: "{{ ansible_user_dir }}/.local/share/fonts"
    state: directory
    mode: '0755'

- name: Check if FiraCode NerdFont is already installed
  stat:
    path: "{{ ansible_user_dir }}/.local/share/fonts/FiraCode"
  register: firacode_installed

- name: Download FiraCode NerdFont
  get_url:
    url: https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip
    dest: /tmp/FiraCode.zip
    mode: '0644'
  when: not firacode_installed.stat.exists

- name: Create FiraCode directory
  file:
    path: "{{ ansible_user_dir }}/.local/share/fonts/FiraCode"
    state: directory
    mode: '0755'
  when: not firacode_installed.stat.exists

- name: Extract FiraCode NerdFont
  unarchive:
    src: /tmp/FiraCode.zip
    dest: "{{ ansible_user_dir }}/.local/share/fonts/FiraCode"
    remote_src: yes
    creates: "{{ ansible_user_dir }}/.local/share/fonts/FiraCode/FiraCodeNerdFont-Regular.ttf"
  when: not firacode_installed.stat.exists

- name: Update font cache
  command: fc-cache -fv
  changed_when: false

- name: Configure console-setup for UTF-8 support
  copy:
    dest: /etc/default/console-setup
    mode: '0644'
    content: |
      # CONFIGURATION FILE FOR SETUPCON
      # Managed by Ansible

      ACTIVE_CONSOLES="/dev/tty[1-6]"

      CHARMAP="UTF-8"

      # Uni2 provides good Unicode coverage for console
      CODESET="Uni2"
      FONTFACE="Terminus"
      FONTSIZE="16"

      VIDEOMODE=
  become: yes
  notify: Apply console setup

- name: Disable default Ubuntu MOTD scripts
  file:
    path: "/etc/update-motd.d/{{ item }}"
    mode: '0644'
  loop:
    - 00-header
    - 10-help-text
    - 50-landscape-sysinfo
    - 50-motd-news
    - 88-esm-announce
    - 90-updates-available
    - 91-contract-ua-esm-status
    - 91-release-upgrade
    - 95-hwe-eol
  become: yes
  ignore_errors: yes

- name: Disable Ubuntu MOTD helper scripts
  file:
    path: "/etc/update-motd.d/{{ item }}"
    mode: '0644'
  loop:
    - 85-fwupd
    - 90-pemmican
    - 92-unattended-upgrades
    - 97-overlayroot
    - 98-fsck-at-reboot
    - 98-reboot-required
  become: yes
  ignore_errors: yes

- name: Deploy Arclink MOTD script
  template:
    src: 50-arclink.j2
    dest: /etc/update-motd.d/50-arclink
    mode: '0755'
    owner: root
    group: root
  become: yes

- name: Clean up downloaded font archive
  file:
    path: /tmp/FiraCode.zip
    state: absent
