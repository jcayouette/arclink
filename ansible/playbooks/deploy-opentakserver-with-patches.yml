---
- name: Build and Deploy OpenTAKServer with Socket.IO Patches
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    namespace: "tak"
    deployment_manifest: "/tmp/ots-deployment-fixed.yaml"
    ots_version: "1.6.3"
    ui_version: "master"

  roles:
    - remote-docker-build

  tasks:
    - name: Delete existing OpenTAKServer deployment
      command: kubectl delete deployment opentakserver -n {{ namespace }} --ignore-not-found=true
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../kubeconfig"
      register: delete_result
      changed_when: "'deleted' in delete_result.stdout"

    - name: Wait for deployment to be fully deleted
      command: kubectl get deployment opentakserver -n {{ namespace }}
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../kubeconfig"
      register: deployment_check
      until: deployment_check.rc != 0
      retries: 30
      delay: 2
      failed_when: false
      changed_when: false

    - name: Deploy OpenTAKServer with patched images
      command: kubectl apply -f {{ deployment_manifest }}
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../kubeconfig"
      register: apply_result
      changed_when: "'configured' in apply_result.stdout or 'created' in apply_result.stdout"

    - name: Wait for pod to be running
      command: kubectl wait --for=condition=ready pod -l app=opentakserver -n {{ namespace }} --timeout=300s
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../kubeconfig"
      register: wait_result
      changed_when: false

    - name: Get pod name
      command: kubectl get pod -n {{ namespace }} -l app=opentakserver -o jsonpath='{.items[0].metadata.name}'
      environment:
        KUBECONFIG: "{{ playbook_dir }}/../kubeconfig"
      register: pod_name
      changed_when: false

    - name: Check for Socket.IO patches (Python 3.12)
      command: >
        kubectl exec -n {{ namespace }} {{ pod_name.stdout }} -c opentakserver --
        grep "cors_allowed_origins" /app/venv/lib/python3.12/site-packages/opentakserver/extensions.py
      register: patch_check_312
      failed_when: false
      changed_when: false

    - name: Check for Socket.IO patches (Python 3.13)
      command: >
        kubectl exec -n {{ namespace }} {{ pod_name.stdout }} -c opentakserver --
        grep "cors_allowed_origins" /app/venv/lib/python3.13/site-packages/opentakserver/extensions.py
      register: patch_check_313
      failed_when: false
      changed_when: false
      when: patch_check_312.rc != 0

    - name: Set patch status
      set_fact:
        patch_verified: "{{ patch_check_312.rc == 0 or patch_check_313.rc == 0 }}"
        python_version: "{{ '3.12' if patch_check_312.rc == 0 else '3.13' if patch_check_313.rc == 0 else 'unknown' }}"

    - name: Get websocket logs sample
      command: kubectl logs -n {{ namespace }} {{ pod_name.stdout }} -c nginx --tail=10
      register: nginx_logs
      changed_when: false
      failed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "========================================="
          - "OpenTAKServer Deployment Complete!"
          - "========================================="
          - ""
          - "Pod: {{ pod_name.stdout }}"
          - "Python Version: {{ python_version }}"
          - "Socket.IO Patches: {{ 'VERIFIED ✓' if patch_verified else 'NOT FOUND ✗' }}"
          - ""
          - "Images deployed:"
          - "  - {{ registry_address }}/opentakserver:latest"
          - "  - {{ registry_address }}/opentakserver-ui:latest"
          - ""
          - "Socket.IO patches applied:"
          - "  ✓ CORS headers enabled (cors_allowed_origins='*')"
          - "  ✓ RabbitMQ message_queue removed"
          - "  ✓ Ping timeout increased to 60 seconds"
          - ""
          - "Access URL: http://{{ registry_address.split(':')[0] }}:31080"
          - ""
          - "To monitor websockets:"
          - "  kubectl logs -n {{ namespace }} {{ pod_name.stdout }} -c nginx -f | grep socket.io"

    - name: Fail if patches not verified
      fail:
        msg: "Socket.IO patches were not found in the deployed container. Check build process."
      when: not patch_verified
