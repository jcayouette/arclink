---
# Enable Password Authentication Playbook
#
# This playbook re-enables SSH password authentication on all cluster nodes.
# Useful for recovery scenarios or temporary password access needs.
#
# IMPORTANT: This REDUCES security by allowing password-based SSH login!
# Only use when necessary, and disable password auth again when done.
#
# Usage: ansible-playbook playbooks/enable-password-auth.yml

- name: Confirm Password Authentication Enable
  hosts: localhost
  gather_facts: no
  vars_prompt:
    - name: confirm_enable
      prompt: "This will ENABLE password authentication (reduces security). Type 'yes' to confirm"
      private: no
  
  tasks:
    - name: Verify confirmation
      assert:
        that:
          - confirm_enable == "yes"
        fail_msg: "Password authentication enable cancelled - confirmation not provided"

- name: Enable SSH Password Authentication
  hosts: all
  gather_facts: no
  become: yes
  
  tasks:
    - name: Enable password authentication in sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        state: present
        backup: yes
      register: sshd_config
    
    - name: Enable challenge-response authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ChallengeResponseAuthentication'
        line: 'ChallengeResponseAuthentication yes'
        state: present
    
    - name: Enable PAM authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?UsePAM'
        line: 'UsePAM yes'
        state: present
    
    - name: Restart SSH service
      systemd:
        name: ssh
        state: restarted
      when: sshd_config.changed
    
    - name: Display status
      debug:
        msg: "✓ Password authentication enabled on {{ inventory_hostname }}"

- name: Verify Password Authentication Enabled
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Display completion message
      debug:
        msg:
          - "============================================"
          - "PASSWORD AUTHENTICATION ENABLED"
          - "============================================"
          - ""
          - "✓ Password auth enabled on {{ groups['all'] | length }} nodes"
          - "✓ SSH config backed up"
          - "✓ SSH service restarted"
          - ""
          - "⚠️  SECURITY WARNING:"
          - "  - Password-based SSH login is now allowed"
          - "  - This increases brute-force attack risk"
          - "  - SSH keys still work (recommended)"
          - ""
          - "When done, disable password auth again:"
          - "  ansible-playbook playbooks/disable-password-auth.yml"
