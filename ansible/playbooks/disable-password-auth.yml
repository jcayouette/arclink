---
# Disable Password Authentication Playbook
#
# This playbook disables SSH password authentication on all cluster nodes
# for security. Only SSH key-based authentication will be allowed.
#
# IMPORTANT: Run this AFTER bootstrap.yml completes successfully!
#
# Usage: ansible-playbook playbooks/disable-password-auth.yml

- name: Verify SSH Keys Work on All Nodes
  hosts: all
  gather_facts: no
  
  tasks:
    - name: Test SSH key-based authentication (no password)
      command: ssh -o BatchMode=yes -o ConnectTimeout=5 -o PreferredAuthentications=publickey -o User={{ ansible_user }} {{ ansible_host }} "echo success"
      register: ssh_test
      delegate_to: localhost
      failed_when: ssh_test.rc != 0
      changed_when: false

- name: Report Verification Failures
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Collect failed nodes
      set_fact:
        failed_nodes: "{{ groups['all'] | map('extract', hostvars) | selectattr('ssh_test', 'defined') | selectattr('ssh_test.rc', 'ne', 0) | map(attribute='inventory_hostname') | list }}"
    
    - name: Display verification failure
      fail:
        msg:
          - "============================================"
          - "SSH KEY VERIFICATION FAILED"
          - "============================================"
          - ""
          - "❌ SSH key authentication is not working on {{ failed_nodes | length }} node(s):"
          - "{{ failed_nodes | join(', ') }}"
          - ""
          - "You MUST run bootstrap to distribute SSH keys:"
          - "  ansible-playbook playbooks/bootstrap.yml --ask-pass"
          - ""
          - "⚠️  DO NOT disable password authentication until"
          - "    SSH keys work on ALL nodes, or you will be"
          - "    locked out of unreachable nodes!"
          - ""
      when: failed_nodes | length > 0
    
    - name: Display verification success
      debug:
        msg: "✓ SSH key authentication verified on all {{ groups['all'] | length }} nodes - proceeding"

- name: Disable SSH Password Authentication
  hosts: all
  gather_facts: no
  become: yes
  
  tasks:
    - name: Disable password authentication in sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
        backup: yes
      register: sshd_config
    
    - name: Disable challenge-response authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ChallengeResponseAuthentication'
        line: 'ChallengeResponseAuthentication no'
        state: present
    
    - name: Disable PAM authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?UsePAM'
        line: 'UsePAM no'
        state: present
    
    - name: Restart SSH service
      systemd:
        name: ssh
        state: restarted
      when: sshd_config.changed
    
    - name: Display status
      debug:
        msg: "✓ Password authentication disabled on {{ inventory_hostname }}"

- name: Verify Password Authentication Disabled
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Test password authentication (should fail)
      command: ssh -o BatchMode=yes -o ConnectTimeout=3 {{ groups['k3s_master'][0] }} "echo test"
      register: verify_test
      failed_when: false
      changed_when: false
    
    - name: Display verification result
      debug:
        msg: "{{ '✓ Password authentication successfully disabled' if verify_test.rc == 0 else '✓ Key-based authentication working' }}"

- name: Summary
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Display completion message
      debug:
        msg:
          - "============================================"
          - "PASSWORD AUTHENTICATION DISABLED"
          - "============================================"
          - ""
          - "✓ Password auth disabled on {{ groups['all'] | length }} nodes"
          - "✓ SSH config backed up"
          - "✓ SSH service restarted"
          - ""
          - "Security improvements:"
          - "  - Only SSH key authentication allowed"
          - "  - Protection against brute-force attacks"
          - "  - Production security best practice"
          - ""
          - "⚠️  IMPORTANT: Keep your SSH private key safe!"
          - "    Location: ~/.ssh/id_ed25519"
          - ""
          - "Next steps:"
          - "  Continue with: ansible-playbook playbooks/setup-common.yml"
